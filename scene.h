#pragma once // 防止头文件重复包含
#include "common.h" // 需要用到 Vec 结构体
#include <string>
#include <vector>

// ======================================================================================
// 1. 枚举定义 (Enums) - C 语言标准风格
// ======================================================================================

// [材质类型]
// 决定光线打到物体表面后怎么反弹
enum Refl_t { 
    DIFF, // 漫反射 (Diffuse): 粗糙表面，向四周均匀散射 (如墙壁、纸张)
    SPEC, // 镜面反射 (Specular): 光滑表面，遵循反射定律 (如镜子、金属)
    REFR  // 折射 (Refractive): 透明介质，遵循斯涅尔定律 (如玻璃、水)
};

// [形状类型]
// 决定使用哪个数学公式来计算光线交点
enum Shape_t { 
    SPHERE, // 球体: (p - c)^2 = r^2
    PLANE   // 平面: n · p = d
};

// ======================================================================================
// 2. 物体结构体 (Object) - 内存布局分析
// ======================================================================================
// 这是一个"多态"结构体。根据 type 的不同，rad 和 p 代表不同的含义。
// 
// [内存布局图解 (Memory Layout)]
// 由于 Vec 被强制 __align__(16)，编译器为了保证对齐，会在成员变量之间插入填充(Padding)。
// 假设起始地址为 0x00:
// -----------------------------------------------------------
// Offset | Size | Member         | Note
// -----------------------------------------------------------
// 0x00   | 4    | float rad      | 半径 或 平面参数D
// 0x04   | 12   | [PADDING]      | 填充字节，为了让下一个 Vec 对齐到 16 字节边界
// 0x10   | 16   | Vec p          | 球心 或 平面法线 (16字节对齐)
// 0x20   | 16   | Vec e          | 自发光强度
// 0x30   | 16   | Vec c          | 表面颜色
// 0x40   | 4    | enum refl      | 材质
// 0x44   | 4    | enum type      | 形状
// 0x48   | 8    | [PADDING]      | 尾部填充，补齐整个结构体到 16 的倍数 (Total: 80 Bytes)
// -----------------------------------------------------------
// 总大小: 80 字节/对象。
// 即使有填充浪费，但保证了 GPU 读取 Vec 时总是对齐的 (Coalesced Access)，性能最高。
struct Object {
    float rad;    // [复用]: 球体半径 Radius | 平面常数 Offset D
    Vec p;        // [复用]: 球体球心 Position | 平面法线 Normal
    Vec e;        // [自发光]: Emission Color (RGB)
    Vec c;        // [颜色]: Surface Color (RGB)
    Refl_t refl;  // [材质]: Diffuse, Specular, Refractive
    Shape_t type; // [形状]: Sphere, Plane
    int tex_id;   // [纹理] 纹理 ID (-1:无纹理, 0:第一张图...)
};

// ======================================================================================
// 3. 全局常量定义
// ======================================================================================

// 场景中物体的总数 (6面墙 + 2球 + 1灯)
// 这个宏会在 renderer.cu 的循环展开 (#pragma unroll) 中用到，必须是编译期常量。
#define NUM_OBJECTS 9

// 相机参数包 (传给 GPU 用的)
struct CameraParams {
    Vec pos; // 相机位置
    Vec cx;  // 视口 X 向量
    Vec cy;  // 视口 Y 向量
    Vec dir; // 相机朝向
    
    float lens_radius; // 镜头半径 (光圈大小的一半)，0 = 针孔(全清晰)
    float focus_dist;  // 对焦距离 (相机到清晰平面的距离)
};

// --- 场景管理接口 ---
// 使用 std::vector 方便动态管理物体，不用写死数组大小
struct Scene {
    std::vector<Object> objects;
    // [新增] 纹理文件路径
    std::vector<std::string> texture_files;
};

// 工厂函数：创建一个康奈尔盒子场景
Scene create_cornell_box();

