#pragma once
#include "common.h" // 需要 Vec 定义
#include <string>
#include <vector>

// ======================================================================================
// 1. 基础枚举定义
// ======================================================================================

// [材质类型]
// 影响光线反弹的行为 (BSDF)
enum Refl_t {
    DIFF, // 漫反射 (Diffuse): 朗伯余弦分布，模拟粗糙表面
    SPEC, // 镜面反射 (Specular): 完美反射，模拟镜子/金属
    REFR  // 折射 (Refractive): 斯涅尔定律 + 菲涅尔效应，模拟玻璃/水
};

// ======================================================================================
// 2. 物体结构体 (Object) - 纯三角形，极致优化
// ======================================================================================
// [设计理念]:
// - 只保留三角形，移除所有球体/平面支持
// - 内存布局：96字节，完美16字节对齐（6×16）
// - 无浪费，无分支，无类型标记
// --------------------------------------------------------------------------------------
struct Object {
    // --- 48字节：三角形顶点 (3×16) ---
    Vec v0, v1, v2;

    // --- 32字节：材质属性 (2×16) ---
    Vec color;    // 表面颜色 (Albedo)
    Vec emission; // 自发光强度 (Light Source)

    // --- 16字节：标量字段 (4×4) ---
    int tex_id;   // 纹理ID (-1表示无纹理)
    float fuzz;   // 粗糙度 (用于镜面反射)
    Refl_t refl;  // 材质类型
    int padding;  // 填充到96字节对齐
};

// 工厂函数：创建三角形
inline Object make_triangle(Vec v0, Vec v1, Vec v2, Vec color, Refl_t refl,
                            float fuzz = 0.0f, int tex_id = -1, Vec emission = {0,0,0}) {
    return {v0, v1, v2, color, emission, tex_id, fuzz, refl, 0};
}

// ======================================================================================
// 3. 全局配置与相机
// ======================================================================================

// [场景容量]
// 96 bytes * 256 ≈ 24 KB。
// constant memory 上限 64 KB，非常安全。
#define NUM_OBJECTS 256

// [相机参数]
struct CameraParams {
    Vec pos; // 相机世界坐标
    Vec cx;  // 成像平面 X 轴 (已包含 FOV 缩放)
    Vec cy;  // 成像平面 Y 轴 (已包含 FOV 缩放)
    Vec dir; // 相机朝向 (归一化)

    float lens_radius; // 光圈半径 (Aperture / 2)。0 为针孔相机。
    float focus_dist;  // 焦距。光线在何处汇聚。
};

// ======================================================================================
// 4. 场景管理接口
// ======================================================================================

struct Scene {
    std::vector<Object> objects;
    std::vector<std::string> texture_files;
};

// 工厂函数
Scene create_cornell_box();
