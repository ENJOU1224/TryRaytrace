# =============================================================================
# High-Performance CUDA Raytracer Makefile
# =============================================================================
# ä¼˜åŒ–ç›®æ ‡: 
# 1. è‡ªåŠ¨åŒ–: è‡ªåŠ¨å¤„ç†å¤´æ–‡ä»¶ä¾èµ–å…³ç³» (ä¿®æ”¹ .h è‡ªåŠ¨é‡ç¼–ç›¸å…³ .cpp/.cu)
# 2. é«˜æ€§èƒ½: å¼€å¯ AVX2 (CPU) å’Œ Fast Math (GPU)
# 3. ç»“æž„åŒ–: æºç /å¤´æ–‡ä»¶/äºŒè¿›åˆ¶/èµ„æº åˆ†ç¦»
# =============================================================================

# -----------------------------------------------------------------------------
# 1. ç›®å½•ç»“æž„é…ç½®
# -----------------------------------------------------------------------------
SRC_DIR   = src
INC_DIR   = include
OBJ_DIR   = bin
ASSET_DIR = assets

# æœ€ç»ˆå¯æ‰§è¡Œæ–‡ä»¶è·¯å¾„
TARGET = $(OBJ_DIR)/cuda_engine

# æºæ–‡ä»¶åˆ—è¡¨
# è¿™é‡Œæˆ‘ä»¬æ˜¾å¼åˆ—å‡ºå¯¹è±¡æ–‡ä»¶ï¼ŒMake ä¼šæ ¹æ®æ¨¡å¼è§„åˆ™åŽ» src/ æ‰¾å¯¹åº”çš„æºæ–‡ä»¶
OBJS_NAMES = bvh.o renderer.o pipeline.o camera.o scene.o loader.o input.o image_io.o main.o
OBJS = $(addprefix $(OBJ_DIR)/, $(OBJS_NAMES))

# -----------------------------------------------------------------------------
# 2. ç¼–è¯‘å™¨ä¸Žé€‰é¡¹é…ç½®
# -----------------------------------------------------------------------------

# --- Host Compiler (C++) ---
CXX = g++

# CXXFLAGS è¯¦è§£:
# -O3             : æœ€é«˜çº§åˆ«ä¼˜åŒ– (å¾ªçŽ¯å±•å¼€, å†…è”ç­‰)
# -march=native   : [æ€§èƒ½å…³é”®] é’ˆå¯¹æœ¬æœº CPU (i7-9750H) å¼€å¯ AVX2/FMA æŒ‡ä»¤é›†
# -fopenmp        : å¼€å¯å¤šçº¿ç¨‹æ”¯æŒ
# -Wall -Wextra   : å¼€å¯å¤§éƒ¨åˆ†è­¦å‘Š
# -Wno-unknown-pragmas : å¿½ç•¥æœªçŸ¥çš„ #pragma (é˜²æ­¢ OpenMP åœ¨éž MP æ¨¡å¼ä¸‹æŠ¥è­¦)
# -I...           : å¤´æ–‡ä»¶æœç´¢è·¯å¾„
# -MMD -MP        : [å·¥ç¨‹å…³é”®] è‡ªåŠ¨ç”Ÿæˆ .d ä¾èµ–æ–‡ä»¶ï¼Œä¿®æ”¹ .h èƒ½è‡ªåŠ¨é‡ç¼–
CXXFLAGS = -O3 -march=native -fopenmp -Wall -Wextra -Wno-unknown-pragmas \
           -I$(SRC_DIR) -I$(INC_DIR) -MMD -MP

# --- Device Compiler (CUDA) ---
NVCC = nvcc

# æž¶æž„è®¾ç½®: 1660 Ti å±žäºŽ Turing æž¶æž„ï¼Œè®¡ç®—èƒ½åŠ› 7.5
ARCH = -arch=sm_75

# NVCC_FLAGS è¯¦è§£:
# -O3             : Host ç«¯ä»£ç ä¼˜åŒ–
# -Xptxas -O3     : [æ€§èƒ½å…³é”®] å‘Šè¯‰ PTX æ±‡ç¼–å™¨è¿›è¡Œæœ€é«˜çº§åˆ«ä¼˜åŒ–
# --use_fast_math : [æ€§èƒ½å…³é”®] ä½¿ç”¨ç¡¬ä»¶å†…ç½®çš„å¿«é€Ÿæ•°å­¦å‡½æ•° (å¦‚ __sinf), ç‰ºç‰²å¾®å°ç²¾åº¦æ¢å–é€Ÿåº¦
# -I...           : å¤´æ–‡ä»¶æœç´¢è·¯å¾„
NVCC_FLAGS = -O3 $(ARCH) --use_fast_math -Xptxas -O3 -I$(SRC_DIR) -I$(INC_DIR)

# --- Linker (é“¾æŽ¥å™¨) ---
# æœ€ç»ˆé“¾æŽ¥é€šå¸¸äº¤ç»™ NVCC å¤„ç†ï¼Œå®ƒä¼šè‡ªåŠ¨ä¼ é€’å‚æ•°ç»™ GCC
LDFLAGS = -lSDL2 -lgomp -Xcompiler -fopenmp

# CUDA å¤´æ–‡ä»¶è·¯å¾„ (å¤‡ç”¨ï¼Œé˜²æ­¢ g++ æ‰¾ä¸åˆ° cuda_runtime.h)
CUDA_INC = -I/usr/local/cuda/include -I/usr/lib/nvidia-cuda-toolkit/include

# -----------------------------------------------------------------------------
# 3. æž„å»ºè§„åˆ™
# -----------------------------------------------------------------------------

# é»˜è®¤ç›®æ ‡
all: dir $(TARGET)

# åˆ›å»ºè¾“å‡ºç›®å½•
dir:
	@mkdir -p $(OBJ_DIR)

# é“¾æŽ¥æ­¥éª¤
# $^ ä»£è¡¨æ‰€æœ‰ä¾èµ–æ–‡ä»¶ (å³ $(OBJS))
# $@ ä»£è¡¨ç›®æ ‡æ–‡ä»¶ (å³ $(TARGET))
$(TARGET): $(OBJS)
	@echo "ðŸ”— Linking $@"
	@$(NVCC) $^ -o $@ $(LDFLAGS)

# --- è§„åˆ™: ç¼–è¯‘ C++ æ–‡ä»¶ (.cpp -> .o) ---
$(OBJ_DIR)/%.o: $(SRC_DIR)/%.cpp
	@echo "ðŸ”¨ Compiling C++ $<"
	@$(CXX) $(CXXFLAGS) $(CUDA_INC) -c $< -o $@

# --- è§„åˆ™: ç¼–è¯‘ CUDA æ–‡ä»¶ (.cu -> .o) ---
$(OBJ_DIR)/%.o: $(SRC_DIR)/%.cu
	@echo "âš¡ Compiling CUDA $<"
	@$(NVCC) $(NVCC_FLAGS) -c $< -o $@

# --- å¼•å…¥è‡ªåŠ¨ç”Ÿæˆçš„ä¾èµ–æ–‡ä»¶ ---
# å¦‚æžœ .d æ–‡ä»¶å­˜åœ¨ï¼ŒMake ä¼šè¯»å–å®ƒï¼Œä»Žè€ŒçŸ¥é“å“ªäº› .cpp ä¾èµ–å“ªäº› .h
-include $(OBJS:.o=.d)

# è¿è¡Œç¨‹åº
run: all
	@echo "ðŸš€ Running..."
	@./$(TARGET)

# æ¸…ç†æž„å»ºäº§ç‰©
clean:
	@echo "ðŸ§¹ Cleaning up..."
	@rm -rf $(OBJ_DIR)

# ä¼ªç›®æ ‡ (é˜²æ­¢ç›®å½•ä¸‹æœ‰åŒåæ–‡ä»¶å¯¼è‡´å†²çª)
.PHONY: all dir clean run
